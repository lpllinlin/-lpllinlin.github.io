<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说阅读器 (带书架功能)</title>
    <style>
        /* 引入网络字体 - 文霞泛讯屏幕楷体 */
        @import url('https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css');
        
        :root {
            --primary-color: #4a76a8;
            --primary-dark-color: #3a5a78;
            --highlight-color: #e6f7ff;
            --danger-color: #e74c3c;
            --danger-dark-color: #c0392b;
            --bg-color: #f5f5f5;
            --container-bg: #ffffff;
            --text-color: #333333;
            --text-secondary-color: #666;
            --border-color: #dddddd;
            --border-dashed-color: #dddddd;
            --highlight-bg: #fff3cd;

            /* 阅读区域字体和行距，可以通过JS动态修改 */
            --novel-font-family: "LXGW WenKai Screen", "Microsoft YaHei", sans-serif;
            --novel-font-size: 1.3em;
            --novel-line-height: 1.7;
        }

        [data-theme='dark'] {
            --primary-color: #5a8bcd;
            --primary-dark-color: #4a76a8;
            --highlight-color: #1c2e42;
            --danger-color: #f76c5e;
            --danger-dark-color: #e74c3c;
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --border-color: #444444;
            --border-dashed-color: #555555;
            --highlight-bg: #5a4a1d;
        }

        [data-theme='sepia'] {
            --bg-color: #f4e8c8;
            --container-bg: #f4e8c8;
            --text-color: #5b4636;
            --text-secondary-color: #7b6656;
            --primary-color: #a56a43;
            --primary-dark-color: #855a33;
            --highlight-color: #e6dbb8;
            --danger-color: #c35c4e;
            --danger-dark-color: #a34c3e;
            --border-color: #dcd0b0;
            --border-dashed-color: #dcd0b0;
            --highlight-bg: #d9c494;
        }

        [data-theme='green'] {
            --bg-color: #cce8cf;
            --container-bg: #e1f2e3;
            --text-color: #212121;
            --text-secondary-color: #555;
            --primary-color: #3d8b40;
            --primary-dark-color: #2d6b30;
            --highlight-color: #d4f7d6;
            --danger-color: #c04c3e;
            --danger-dark-color: #a03c2e;
            --border-color: #b8d8bb;
            --border-dashed-color: #b8d8bb;
            --highlight-bg: #b7e0ba;
        }

        body { 
            font-family: var(--novel-font-family);
            margin: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; margin: 20px auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding-bottom: 80px; transition: background-color 0.3s, box-shadow 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; transition: opacity 0.3s ease-in-out; }
        .header h2 { margin: 0; color: var(--text-color); }
        .header .controls-group { display: flex; gap: 10px; align-items: center; }

        .novel-section { 
            flex: 1; 
            overflow-y: auto; 
            max-height: 80vh; 
            font-size: var(--novel-font-size);
            line-height: var(--novel-line-height);
            transition: font-size 0.3s, line-height 0.3s;
        }
        .paragraph { padding: 15px; margin-bottom: 10px; background: var(--container-bg); border-left: 4px solid var(--primary-color); border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .paragraph:hover { background: var(--highlight-color); }
        .paragraph.active { background: var(--highlight-color); border-left-color: #1890ff; }
        .paragraph.has-reviews { border-left-color: var(--danger-color); }
        
        .chapter-selector { padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--container-bg); color: var(--text-color); }
        .reviews-section { flex: 1; overflow-y: auto; max-height: 80vh; }
        .review-container { padding: 15px; margin-bottom: 10px; background: var(--bg-color); border-radius: 4px; border-left: 3px solid var(--danger-color); }
        .review-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-dashed-color); font-size: 1.2em; line-height: 1.6; }
        .review-item:last-child { border-bottom: none; }
        .review-user { font-weight: bold; color: var(--primary-color); }
        .highlight { background-color: var(--highlight-bg); padding: 0 2px; }
        .search-box { margin-bottom: 15px; padding: 10px; width: 100%; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; background-color: var(--container-bg); color: var(--text-color); }
        .review-count { font-size: 0.8em; color: var(--danger-color); margin-left: 10px; }
        .loading { text-align: center; padding: 20px; font-size: 1.2em; color: var(--text-secondary-color);}
        .chapter-title { font-size: 1.5em; margin: 20px 0; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color); color: var(--text-color); }
        .file-input-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; padding: 20px; border: 2px dashed var(--border-color); border-radius: 8px; }
        .file-input-group { margin-bottom: 10px; }
        .no-reviews { color: var(--text-secondary-color); font-style: italic; }
        .review-files-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .review-file-item { background: var(--highlight-color); padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; transition: opacity 0.3s ease-in-out;}
        .btn { background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .btn:hover { background: var(--primary-dark-color); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-dark-color); }
        .bottom-controls-container { position: fixed; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px; z-index: 1000; padding: 10px; pointer-events: none; transition: opacity 0.3s ease-in-out;}
        .bottom-controls-container button { pointer-events: auto; padding: 10px 15px; border-radius: 20px; opacity: 0.85; min-width: auto; }
        .chapter-menu { position: fixed; top: 0; left: 0; width: 80%; max-width: 300px; height: 100%; background: var(--container-bg); box-shadow: 2px 0 10px rgba(0,0,0,0.2); z-index: 2000; overflow-y: auto; transform: translateX(-100%); transition: transform 0.3s ease; }
        .chapter-menu.active { transform: translateX(0); }
        .chapter-menu-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--primary-color); color: white; }
        .chapter-menu-close { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .chapter-menu-item { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .chapter-menu-item:hover { background: var(--highlight-color); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; display: none; }
        .overlay.active { display: block; }
        .book-list-container { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;}
        .book-item { display: flex; flex-direction: column; justify-content: space-between; padding: 15px; background: var(--container-bg); border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); border-left: 5px solid var(--primary-color); }
        .book-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .book-progress { font-size: 0.9em; color: var(--text-secondary-color); margin-bottom: 15px; }
        .book-actions { display: flex; gap: 10px; margin-top: auto; }
        .content-wrapper { display: flex; gap: 20px; }
        #progressBar { position: fixed; top: 0; left: 0; height: 3px; background-color: var(--primary-color); width: 0%; z-index: 9999; transition: width 0.1s linear; }
        .settings-panel { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%) translateY(120%); background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 1500; transition: transform 0.3s ease-in-out; width: 90%; max-width: 320px; border: 1px solid var(--border-color); }
        .settings-panel.active { transform: translateX(-50%) translateY(0); }
        .setting-item { display: flex; flex-direction: column; margin-bottom: 15px; }
        .setting-item label { margin-bottom: 8px; font-size: 0.9em; color: var(--text-secondary-color); }
        .setting-item input[type="range"] { width: 100%; }
        .theme-options { display: flex; justify-content: space-between; gap: 10px; }
        .theme-options button { flex: 1; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); border-radius: 4px; cursor: pointer; }
        .theme-options button.active { border-color: var(--primary-color); box-shadow: 0 0 5px var(--primary-color); }
        .close-settings-btn { width: 100%; margin-top: 10px; }
        body.immersive-mode .header, body.immersive-mode .bottom-controls-container, body.immersive-mode .controls { opacity: 0; pointer-events: none; }
        @media (max-width: 768px) {
            .content-wrapper { flex-direction: column; }
            .novel-section, .reviews-section { max-height: none; }
            .container { padding: 10px; margin: 0; border-radius: 0; box-shadow: none; padding-bottom: 80px;}
            .current-paragraph-content { background: var(--highlight-color); padding: 10px; border-left: 4px solid #1890ff; margin-bottom: 15px; border-radius: 4px; }
            .chapter-selector { display: none; }
        }
    </style>
</head>
<body>

<div id="progressBar"></div>

<!-- 书架视图 -->
<div id="bookshelfContainer" class="container">
    <div class="header">
        <h2>我的书架</h2>
        <div class="controls-group">
            <button id="themeToggleBtnBookshelf" class="btn">🌙</button>
            <button id="showAddBookViewBtn" class="btn">添加新书</button>
        </div>
    </div>
    <div id="bookList" class="book-list-container"></div>
</div>

<!-- 阅读器视图 -->
<div id="readerContainer" class="container" style="display: none;">
    <div class="header">
        <h2 id="readerTitle">小说阅读器</h2>
        <div class="controls-group">
            <button id="themeToggleBtnReader" class="btn">🌙</button>
            <button id="backToShelfBtn" class="btn">返回书架</button>
            <select id="chapterSelector" class="chapter-selector">
                <option value="all">全部章节</option>
            </select>
        </div>
    </div>
    <div id="addBookSection">
        <div class="file-input-container">
             <h3>添加新书到书架</h3>
            <div class="file-input-group"><label for="novelFile">上传小说文件 (.txt)：</label><input type="file" id="novelFile" accept=".txt"></div>
            <div class="file-input-group"><label for="reviewsFiles">上传本章说文件 (可多选, .txt)：</label><input type="file" id="reviewsFiles" accept=".txt" multiple><div id="reviewFilesContainer" class="review-files-container"></div></div>
            <button id="saveBookBtn" class="btn">保存到书架</button>
        </div>
    </div>
    <div class="controls"><input type="text" class="search-box" id="searchBox" placeholder="搜索小说内容或本章说..."><button class="btn" id="clearSearchBtn">清除搜索</button></div>
    <div id="loadingIndicator" class="loading">请上传文件...</div>
    <div class="content-wrapper">
        <div id="novelContent" class="novel-section"></div>
        <div id="reviewsContent" class="reviews-section"><h3>本章说</h3><div id="currentReviews" class="review-container"><div class="no-reviews">请点击左侧段落查看对应本章说</div></div></div>
    </div>
</div>

<!-- 通用组件 -->
<div id="chapterMenu" class="chapter-menu"><div class="chapter-menu-header"><h3>章节目录</h3><button id="closeChapterMenu" class="chapter-menu-close">×</button></div><div id="chapterMenuItems"></div></div>
<div id="overlay" class="overlay"></div>
<div class="bottom-controls-container">
    <button id="prevChapterBtn" class="btn">上一章</button>
    <button id="chapterMenuToggle" class="btn">章节</button>
    <button id="mobileViewToggle" class="btn mobile-view-toggle-btn">查看本章说</button>
    <button id="settingsToggleBtn" class="btn">设置</button>
    <button id="nextChapterBtn" class="btn">下一章</button>
</div>
<div id="settingsPanel" class="settings-panel">
    <div class="setting-item">
        <label for="fontSizeSlider">字体大小</label>
        <input type="range" id="fontSizeSlider" min="1.0" max="2.0" step="0.05">
    </div>
    <div class="setting-item">
        <label for="lineHeightSlider">行间距</label>
        <input type="range" id="lineHeightSlider" min="1.5" max="2.5" step="0.1">
    </div>
    <div class="setting-item">
        <label>阅读主题</label>
        <div id="themeOptions" class="theme-options">
            <button data-theme="light">明亮</button>
            <button data-theme="dark">暗黑</button>
            <button data-theme="sepia">牛皮纸</button>
            <button data-theme="green">护眼</button>
        </div>
    </div>
    <button id="closeSettingsBtn" class="btn close-settings-btn">关闭</button>
</div>

<script>
    // =============================================
    // IndexedDB 数据库帮助模块
    // =============================================
    const db = {
        _db: null, _dbName: 'novelReaderDB', _storeName: 'books',
        async openDB() {
            return new Promise((resolve, reject) => {
                if (this._db) { resolve(this._db); return; }
                const request = indexedDB.open(this._dbName, 1);
                request.onerror = (event) => reject("IndexedDB error: " + request.error);
                request.onsuccess = (event) => { this._db = event.target.result; resolve(this._db); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(this._storeName)) {
                        db.createObjectStore(this._storeName, { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        },
        async addBook(bookData) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction([this._storeName], 'readwrite'); const store = transaction.objectStore(this._storeName); const request = store.add(bookData); request.onsuccess = resolve; request.onerror = () => reject(request.error); }); },
        async getAllBooks() { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction([this._storeName], 'readonly'); const store = transaction.objectStore(this._storeName); const request = store.getAll(); request.onsuccess = () => resolve(request.result); request.onerror = () => reject(request.error); }); },
        async getBook(id) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction([this._storeName], 'readonly'); const store = transaction.objectStore(this._storeName); const request = store.get(id); request.onsuccess = () => resolve(request.result); request.onerror = () => reject(request.error); }); },
        async deleteBook(id) { const db = await this.openDB(); return new Promise((resolve, reject) => { const transaction = db.transaction([this._storeName], 'readwrite'); const store = transaction.objectStore(this._storeName); const request = store.delete(id); request.onsuccess = resolve; request.onerror = () => reject(request.error); }); },
        async updateBook(id, updates) {
            const db = await this.openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([this._storeName], 'readwrite');
                const store = transaction.objectStore(this._storeName);
                const getRequest = store.get(id);

                getRequest.onsuccess = () => {
                    const book = getRequest.result;
                    if (book) {
                        Object.assign(book, updates);
                        const putRequest = store.put(book);
                        putRequest.onsuccess = resolve;
                        putRequest.onerror = () => reject(putRequest.error);
                    } else {
                        reject('Book not found for update.');
                    }
                };
                getRequest.onerror = () => reject(getRequest.error);
            });
        }
    };
    
    let allChapters = [], allReviews = {}, currentChapterIndex = 'all', currentParagraph = null, activeParaElement = null, scrollPosBeforeReview = 0, currentView = 'novel', currentBookId = null;

    // =============================================
    // URL 数据加载模块 (新增)
    // =============================================
    function loadDataFromUrl() {
        if (window.location.hash && window.location.hash.startsWith('#data=')) {
            const encodedData = window.location.hash.substring(6);
            try {
                const jsonData = JSON.parse(decodeURIComponent(encodedData));
                
                if (jsonData.novelContent && jsonData.reviews) {
                    console.log("成功从URL加载数据！");
                    
                    showReaderView(true);
                    
                    allChapters = [];
                    allReviews = {};
                    currentChapterIndex = 0; // 只有一章，所以索引是0
                    clearActiveParagraphAndReviews();

                    document.getElementById('readerTitle').textContent = jsonData.bookTitle || '在线阅读';
                    
                    // 将传递过来的单章内容和评论，包装成阅读器需要的格式
                    allChapters.push({
                        fullTitle: jsonData.chapterTitle,
                        identifier: "在线章节",
                        cleanTitle: jsonData.chapterTitle,
                        paragraphs: jsonData.novelContent.split('\n').map(p => p.trim()).filter(p => p.length > 0)
                    });
                    
                    // 本章说数据格式已经匹配，直接赋值
                    allReviews = jsonData.reviews;

                    renderContent();
                    updateChapterNavButtons();
                    
                    // 清理URL，防止刷新时重复加载
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                    return true;
                }
            } catch (error) {
                console.error("从URL解码数据失败:", error);
                alert("加载URL中的阅读数据失败！可能是数据过大或格式错误。");
            }
        }
        return false;
    }

    // =============================================
    // 初始加载和事件绑定
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
        // 优先尝试从URL加载数据，如果失败或没有数据，再执行原有的书架逻辑
        if (!loadDataFromUrl()) {
            showBookshelfView();
        }
        
        // 其他所有事件绑定照常进行
        document.querySelectorAll('#themeToggleBtnBookshelf, #themeToggleBtnReader').forEach(btn => btn.addEventListener('click', toggleLegacyTheme));
        document.getElementById('showAddBookViewBtn').addEventListener('click', showAddBookView);
        document.getElementById('backToShelfBtn').addEventListener('click', showBookshelfView);
        document.getElementById('saveBookBtn').addEventListener('click', handleSaveBook);
        document.getElementById('reviewsFiles').addEventListener('change', handleReviewFilesPreview);
        document.getElementById('chapterSelector').addEventListener('change', function() { currentChapterIndex = this.value; clearActiveParagraphAndReviews(); renderContent(); updateChapterNavButtons(); window.scrollTo(0, 0); });
        document.getElementById('searchBox').addEventListener('keyup', function() { searchText(this.value); });
        document.getElementById('clearSearchBtn').addEventListener('click', function() { document.getElementById('searchBox').value = ''; searchText(''); });
        document.getElementById('mobileViewToggle').addEventListener('click', toggleMobileView);
        document.getElementById('chapterMenuToggle').addEventListener('click', toggleChapterMenu);
        document.getElementById('closeChapterMenu').addEventListener('click', toggleChapterMenu);
        document.getElementById('overlay').addEventListener('click', () => { closeAllPopups(); });
        document.getElementById('prevChapterBtn').addEventListener('click', goToPreviousChapter);
        document.getElementById('nextChapterBtn').addEventListener('click', goToNextChapter);
        
        setupComfortFeatures();

        window.addEventListener('scroll', handleScroll);
        window.addEventListener('resize', handleResize);
        handleResize();
    });

    // =============================================
    // 舒适性功能模块
    // =============================================
    function setupComfortFeatures() {
        const settingsPanel = document.getElementById('settingsPanel');
        document.getElementById('settingsToggleBtn').addEventListener('click', () => settingsPanel.classList.toggle('active'));
        document.getElementById('closeSettingsBtn').addEventListener('click', () => settingsPanel.classList.remove('active'));
        
        applyInitialTheme();
        const themeOptions = document.getElementById('themeOptions');
        themeOptions.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                applyTheme(e.target.dataset.theme);
            }
        });

        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const lineHeightSlider = document.getElementById('lineHeightSlider');
        loadReadingSettings();

        fontSizeSlider.addEventListener('input', function() {
            document.documentElement.style.setProperty('--novel-font-size', this.value + 'em');
        });
        fontSizeSlider.addEventListener('change', function() {
            saveReadingSettings('fontSize', this.value);
        });

        lineHeightSlider.addEventListener('input', function() {
            document.documentElement.style.setProperty('--novel-line-height', this.value);
        });
        lineHeightSlider.addEventListener('change', function() {
            saveReadingSettings('lineHeight', this.value);
        });

        document.getElementById('novelContent').addEventListener('click', function(e) {
            if (e.target.id === 'novelContent' || e.target.classList.contains('chapter-title')) {
                if (window.innerWidth > 768) {
                    document.body.classList.toggle('immersive-mode');
                }
            }
        });
        
        document.addEventListener('keydown', handleKeyboardShortcuts);
    }

    function handleScroll() {
        if (window.innerWidth > 768 || (window.innerWidth <= 768 && currentView === 'novel')) { 
            scrollPosBeforeReview = window.pageYOffset || document.documentElement.scrollTop; 
        }
        updateProgressBar();
    }

    function updateProgressBar() {
        const progressBar = document.getElementById('progressBar');
        const contentHeight = document.documentElement.scrollHeight;
        const viewportHeight = window.innerHeight;
        if (contentHeight <= viewportHeight) {
            progressBar.style.width = '0%';
            return;
        }
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const progress = (scrollTop / (contentHeight - viewportHeight)) * 100;
        progressBar.style.width = Math.min(progress, 100) + '%';
    }

    function handleKeyboardShortcuts(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                goToPreviousChapter();
                break;
            case 'ArrowRight':
                e.preventDefault();
                goToNextChapter();
                break;
            case 'Escape':
                e.preventDefault();
                closeAllPopups();
                break;
        }
    }
    
    function closeAllPopups() {
        document.getElementById('chapterMenu').classList.remove('active');
        document.getElementById('settingsPanel').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
    }

    // =============================================
    // 主题和阅读设置
    // =============================================
    function applyTheme(theme) { 
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme); 
        const themeOptions = document.getElementById('themeOptions');
        themeOptions.querySelectorAll('button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
        const isDark = theme === 'dark';
        document.querySelectorAll('#themeToggleBtnBookshelf, #themeToggleBtnReader').forEach(btn => btn.textContent = isDark ? '☀️' : '🌙');
    }

    function applyInitialTheme() { 
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; 
        if (savedTheme) { 
            applyTheme(savedTheme); 
        } else { 
            applyTheme(systemPrefersDark ? 'dark' : 'light'); 
        } 
    }
    
    function toggleLegacyTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = (currentTheme === 'light' || currentTheme === 'sepia' || currentTheme === 'green') ? 'dark' : 'light';
        applyTheme(newTheme);
    }
    
    function loadReadingSettings() {
        const settings = JSON.parse(localStorage.getItem('readingSettings')) || {};
        const fontSize = settings.fontSize || '1.3';
        const lineHeight = settings.lineHeight || '1.7';

        document.documentElement.style.setProperty('--novel-font-size', fontSize + 'em');
        document.documentElement.style.setProperty('--novel-line-height', lineHeight);

        document.getElementById('fontSizeSlider').value = fontSize;
        document.getElementById('lineHeightSlider').value = lineHeight;
    }

    function saveReadingSettings(key, value) {
        let settings = JSON.parse(localStorage.getItem('readingSettings')) || {};
        settings[key] = value;
        localStorage.setItem('readingSettings', JSON.stringify(settings));
    }


    // =============================================
    // 书架和视图管理
    // =============================================
    function showBookshelfView() { document.getElementById('bookshelfContainer').style.display = 'block'; document.getElementById('readerContainer').style.display = 'none'; renderBookshelf(); currentBookId = null; document.body.classList.remove('immersive-mode'); }
    function showReaderView(isReading) { document.getElementById('bookshelfContainer').style.display = 'none'; document.getElementById('readerContainer').style.display = 'block'; document.getElementById('addBookSection').style.display = isReading ? 'none' : 'block'; document.getElementById('loadingIndicator').style.display = isReading ? 'none' : 'block'; document.querySelector('.controls').style.display = isReading ? 'flex' : 'none'; document.querySelector('.content-wrapper').style.display = isReading ? 'flex' : 'none'; document.querySelector('.bottom-controls-container').style.display = isReading ? 'flex' : 'none'; }
    function showAddBookView() { showReaderView(false); document.getElementById('readerTitle').textContent = '添加新书'; document.getElementById('loadingIndicator').textContent = '请上传文件并保存到书架...'; document.getElementById('reviewFilesContainer').innerHTML = ''; document.getElementById('novelFile').value = ''; document.getElementById('reviewsFiles').value = ''; }
    
    async function renderBookshelf() {
        const bookListDiv = document.getElementById('bookList');
        bookListDiv.innerHTML = '<div class="loading">加载书架中...</div>';
        try {
            const books = await db.getAllBooks();
            bookListDiv.innerHTML = '';
            if (books.length === 0) {
                bookListDiv.innerHTML = '<p>书架是空的，请从右上角“添加新书”。</p>';
                return;
            }
            books.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                let progressHTML = '<div class="book-progress">尚未开始阅读</div>';
                if (book.lastChapterTitle) {
                     progressHTML = `<div class="book-progress">上次读到: ${book.lastChapterTitle.substring(0, 25)}...</div>`;
                } else if (book.lastReadTimestamp) {
                    progressHTML = `<div class="book-progress">上次阅读: ${new Date(book.lastReadTimestamp).toLocaleString()}</div>`;
                }
                bookItem.innerHTML = `<div class="book-title">${book.title || '无标题书籍'}</div>${progressHTML}<div class="book-actions"><button class="btn read-btn" data-id="${book.id}">阅读</button><button class="btn btn-danger delete-btn" data-id="${book.id}">删除</button></div>`;
                bookListDiv.appendChild(bookItem);
            });
            bookListDiv.querySelectorAll('.read-btn').forEach(btn => btn.addEventListener('click', (e) => loadBookForReading(parseInt(e.target.dataset.id))));
            bookListDiv.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteBook(parseInt(e.target.dataset.id))));
        } catch (error) {
            bookListDiv.innerHTML = '<p style="color:red;">加载书架失败。</p>';
            console.error("Failed to render bookshelf:", error);
        }
    }
    
    async function handleSaveBook() {
        const novelFile = document.getElementById('novelFile').files[0];
        const reviewsFiles = document.getElementById('reviewsFiles').files;
        if (!novelFile) { alert('请先选择小说文件！'); return; }
        const indicator = document.getElementById('loadingIndicator');
        indicator.textContent = '正在读取和解析文件...'; indicator.style.display = 'block';
        try {
            const readFileAsText = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result); reader.onerror = e => reject(e); reader.readAsText(file, 'UTF-8'); });
            const novelContent = await readFileAsText(novelFile);
            const reviewFilesData = [];
            for (const file of reviewsFiles) { const content = await readFileAsText(file); reviewFilesData.push({ name: file.name, content: content }); }
            const tempChapter = parseChapterInfo(novelContent.split('\n')[0] || novelContent.split('\n')[1] || '');
            const bookTitle = (tempChapter && tempChapter.cleanTitle) ? tempChapter.cleanTitle : novelFile.name.replace(/\.txt$/i, '');
            const bookData = { title: bookTitle || "无标题小说", novelContent: novelContent, reviewFiles: reviewFilesData };
            await db.addBook(bookData);
            alert('书籍已成功保存到书架！');
            showBookshelfView();
        } catch (error) {
            alert('保存书籍失败！请检查控制台获取更多信息。'); console.error("Failed to save book:", error); indicator.style.display = 'none';
        }
    }

    async function loadBookForReading(bookId) {
        showReaderView(true);
        const indicator = document.getElementById('loadingIndicator');
        indicator.textContent = '正在从书架加载书籍...'; indicator.style.display = 'block';
        try {
            const book = await db.getBook(bookId);
            if (!book) { alert('找不到这本书！'); showBookshelfView(); return; }
            document.getElementById('readerTitle').textContent = book.title;
            currentBookId = bookId; 
            allChapters = []; allReviews = {}; currentChapterIndex = 'all'; clearActiveParagraphAndReviews();
            parseNovelContent(book.novelContent);
            if(book.reviewFiles && book.reviewFiles.length > 0) { 
                console.log("开始解析本章说文件...");
                book.reviewFiles.forEach(reviewFile => { parseReviewContent(reviewFile.content, reviewFile.name); }); 
            }
            if (book.lastChapterIndex !== undefined && allChapters[book.lastChapterIndex]) {
                 currentChapterIndex = book.lastChapterIndex;
            } else {
                 currentChapterIndex = allChapters.length > 0 ? 0 : 'all';
            }
            document.getElementById('chapterSelector').value = currentChapterIndex;
            renderContent();
            updateChapterNavButtons();
            indicator.style.display = 'none';
            if (book.lastChapterIndex !== undefined && book.lastParaIndex !== undefined) {
                setTimeout(() => {
                    const lastReadParaId = `para-${book.lastChapterIndex}-${book.lastParaIndex}`;
                    const lastReadElement = document.getElementById(lastReadParaId);
                    if (lastReadElement) {
                        lastReadElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        showReviews(book.lastChapterIndex, book.lastParaIndex, lastReadElement);
                    }
                }, 100); 
            }
        } catch (error) {
            alert('加载书籍失败！'); console.error("Failed to load book for reading:", error); showBookshelfView();
        }
    }
    
    async function handleDeleteBook(bookId) { if (confirm('您确定要从书架中删除这本书吗？此操作不可恢复。')) { try { await db.deleteBook(bookId); renderBookshelf(); } catch (error) { alert('删除失败！'); console.error("Failed to delete book:", error); } } }
    function handleReviewFilesPreview() { const files = document.getElementById('reviewsFiles').files; const container = document.getElementById('reviewFilesContainer'); container.innerHTML = ''; for (let i = 0; i < files.length; i++) { const fileItem = document.createElement('div'); fileItem.className = 'review-file-item'; fileItem.textContent = files[i].name; container.appendChild(fileItem); } }
    async function saveReadingProgress(chapterIndex, paraIndex) { if (currentBookId === null) return; try { await db.updateBook(currentBookId, { lastChapterIndex: chapterIndex, lastParaIndex: paraIndex, lastChapterTitle: allChapters[chapterIndex].fullTitle, lastReadTimestamp: Date.now() }); } catch (error) { console.error("Failed to save reading progress:", error); } }

    // =============================================
    // 解析和渲染逻辑
    // =============================================
    function parseChapterInfo(line) {
        if (!line || line.trim().length === 0) return null;
        const trimmedLine = line.trim();
        const textPattern = `第[一二三四五六七八九十百千万零\\d]+章|卷[一二三四五六七八九十百千万零\\d]+|楔子|序章|引子|前言|尾声|后记|番外(?:篇)?[\\s\\d]*`;
        const numPattern = `\\d+`;
        const chapterRegex = new RegExp(`^(?:章节[:：\\s]*)?((?:${textPattern})|(?:${numPattern}))(?:[.．:：\\s]+(.*))?$`);
        const match = trimmedLine.match(chapterRegex);
        if (match) {
            const identifier = (match[1] || '').trim();
            const cleanTitle = (match[2] || '').trim();
            if (/^\d+$/.test(identifier) && cleanTitle.length === 0 && !trimmedLine.includes('.')) return null;
            return { identifier, cleanTitle };
        }
        return null;
    }

    function parseNovelContent(content) {
        allChapters = [];
        const lines = content.split('\n');
        let currentChapterData = null;
        lines.forEach(line => {
            const trimmedLine = line.trim();
            if (trimmedLine.length === 0) { 
                if (currentChapterData) currentChapterData.paragraphs.push(trimmedLine);
                return; 
            }
            const chapterInfo = trimmedLine.length < 100 ? parseChapterInfo(line) : null;
            if (chapterInfo) {
                if (currentChapterData) { allChapters.push(currentChapterData); }
                currentChapterData = { fullTitle: trimmedLine, identifier: chapterInfo.identifier, cleanTitle: chapterInfo.cleanTitle, paragraphs: [] };
            } else if (currentChapterData) {
                currentChapterData.paragraphs.push(trimmedLine);
            }
        });
        if (currentChapterData) { allChapters.push(currentChapterData); }
        if (allChapters.length === 0 && content.trim().length > 0) {
            allChapters.push({ fullTitle: "全文内容", identifier: "第1章", cleanTitle: "", paragraphs: content.split('\n').filter(line => line.trim()).map(line => line.trim()) });
        }
        updateChapterSelector();
    }

    function parseReviewContent(content, fileNameForDebug) {
        let matchedChapterIndex = -1;
        const firstLine = content.split('\n')[0];
        const reviewChapterInfo = parseChapterInfo(firstLine);

        if (reviewChapterInfo) {
            if (reviewChapterInfo.cleanTitle && reviewChapterInfo.cleanTitle.length > 1) {
                matchedChapterIndex = allChapters.findIndex(ch => ch.cleanTitle === reviewChapterInfo.cleanTitle);
            }
            if (matchedChapterIndex === -1) {
                 matchedChapterIndex = allChapters.findIndex(ch => ch.identifier === reviewChapterInfo.identifier);
            }
        }
        
        if (matchedChapterIndex === -1) {
            const fileNameMatch = fileNameForDebug.match(/(?:c(?:h(?:apter)?)?|第|\b)(\d+)\b/i);
            if (fileNameMatch && fileNameMatch[1]) {
                const num = parseInt(fileNameMatch[1], 10);
                matchedChapterIndex = allChapters.findIndex(ch => ch.identifier === `第${num}章` || ch.identifier === `${num}`);
            }
        }
        
        if (matchedChapterIndex === -1) {
            console.warn(`【匹配失败】: [${fileNameForDebug}]`, reviewChapterInfo);
            return;
        }

        if (!allReviews[matchedChapterIndex]) allReviews[matchedChapterIndex] = {};
        const paragraphRegex = /-------本章说 段落-?(\d+)---------/g;
        const reviewsBlocks = content.split(paragraphRegex);
        for (let i = 1; i < reviewsBlocks.length; i += 2) {
            const paraIndex = parseInt(reviewsBlocks[i], 10) - 1;
            const reviewsContent = reviewsBlocks[i + 1].trim();
            if (paraIndex >= 0 && reviewsContent) {
                const reviews = reviewsContent.split('\n').filter(line => line.trim()).map(line => {
                    const parts = line.split(/[:：]/);
                    if (parts.length >= 2) { return { user: parts[0].trim(), text: parts.slice(1).join(':').trim() }; }
                    return null;
                }).filter(Boolean);
                if (reviews.length > 0) {
                    if (!allReviews[matchedChapterIndex][paraIndex]) allReviews[matchedChapterIndex][paraIndex] = [];
                    allReviews[matchedChapterIndex][paraIndex].push(...reviews);
                }
            }
        }
    }
    
    // =============================================
    // 渲染及UI交互
    // =============================================
    function renderContent() { const container = document.getElementById('novelContent'); container.innerHTML = ''; if (allChapters.length === 0) return; if (currentChapterIndex === 'all') { allChapters.forEach((chapter, chapterIndex) => { renderChapter(container, chapter, chapterIndex); }); } else { const chapterIndex = parseInt(currentChapterIndex); if (allChapters[chapterIndex]) { renderChapter(container, allChapters[chapterIndex], chapterIndex); } } searchText(document.getElementById('searchBox').value); setTimeout(updateProgressBar, 100); }
    function renderChapter(container, chapter, chapterIndex) { const titleDiv = document.createElement('div'); titleDiv.className = 'chapter-title'; titleDiv.id = `chapter-title-${chapterIndex}`; titleDiv.textContent = chapter.fullTitle; titleDiv.dataset.chapterIndex = chapterIndex; container.appendChild(titleDiv); chapter.paragraphs.forEach((para, paraIndex) => { const paraDiv = document.createElement('div'); paraDiv.className = 'paragraph'; paraDiv.id = `para-${chapterIndex}-${paraIndex}`; paraDiv.dataset.chapterIndex = chapterIndex; paraDiv.dataset.paraIndex = paraIndex; const hasReviews = allReviews[chapterIndex] && allReviews[chapterIndex][paraIndex] && allReviews[chapterIndex][paraIndex].length > 0; if(hasReviews) paraDiv.classList.add('has-reviews'); const reviewCount = hasReviews ? allReviews[chapterIndex][paraIndex].length : 0; const reviewCountSpan = reviewCount > 0 ? `<span class="review-count">${reviewCount}条</span>` : ''; paraDiv.innerHTML = `<b>段 ${paraIndex + 1}：</b> ${para.replace(/</g, "&lt;").replace(/>/g, "&gt;")} ${reviewCountSpan}`; paraDiv.onclick = function() { scrollPosBeforeReview = window.pageYOffset || document.documentElement.scrollTop; activeParaElement = this; showReviews(chapterIndex, paraIndex, this); }; container.appendChild(paraDiv); }); }
    function updateChapterSelector(){ const selector = document.getElementById('chapterSelector'); const menuItems = document.getElementById('chapterMenuItems'); while (selector.options.length > 1) selector.remove(1); menuItems.innerHTML = ''; const allChaptersItem = document.createElement('div'); allChaptersItem.className = 'chapter-menu-item'; allChaptersItem.textContent = '全部章节'; allChaptersItem.onclick = function() { currentChapterIndex = 'all'; clearActiveParagraphAndReviews(); renderContent(); toggleChapterMenu(); updateChapterNavButtons(); window.scrollTo(0,0); }; menuItems.appendChild(allChaptersItem); allChapters.forEach((chapter, index) => { const option = document.createElement('option'); option.value = index; option.textContent = chapter.fullTitle; selector.appendChild(option); const menuItem = document.createElement('div'); menuItem.className = 'chapter-menu-item'; menuItem.textContent = chapter.fullTitle; menuItem.dataset.chapterIndex = index; menuItem.onclick = function() { currentChapterIndex = index; document.getElementById('chapterSelector').value = index; clearActiveParagraphAndReviews(); renderContent(); toggleChapterMenu(); updateChapterNavButtons(); window.scrollTo(0,0); }; menuItems.appendChild(menuItem); }); selector.value = currentChapterIndex; }
    function showReviews(chapterIndex, paraIndex, paraElement){ saveReadingProgress(chapterIndex, paraIndex); if (currentParagraph && currentParagraph !== paraElement) currentParagraph.classList.remove('active'); paraElement.classList.add('active'); currentParagraph = paraElement; const reviewsContainer = document.getElementById('currentReviews'); reviewsContainer.innerHTML = ''; if (allChapters[chapterIndex] && allChapters[chapterIndex].paragraphs[paraIndex] !== undefined) { const originalPara = document.createElement('div'); originalPara.className = 'current-paragraph-content'; originalPara.innerHTML = `<b>${allChapters[chapterIndex].fullTitle} - 段落 ${paraIndex + 1}</b><br>${allChapters[chapterIndex].paragraphs[paraIndex].replace(/</g, "&lt;").replace(/>/g, "&gt;")}`; reviewsContainer.appendChild(originalPara); } if (allReviews[chapterIndex] && allReviews[chapterIndex][paraIndex]) { allReviews[chapterIndex][paraIndex].forEach(review => { const reviewItem = document.createElement('div'); reviewItem.className = 'review-item'; reviewItem.innerHTML = `<span class="review-user">${review.user.replace(/</g, "&lt;").replace(/>/g, "&gt;")}：</span> ${review.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`; reviewsContainer.appendChild(reviewItem); }); } else { reviewsContainer.innerHTML += '<div class="no-reviews">该段落没有本章说</div>'; } if (window.innerWidth <= 768 && currentView === 'novel') setTimeout(toggleMobileView, 50); else document.getElementById('reviewsContent').scrollTop = 0; }
    function clearActiveParagraphAndReviews(){ if (currentParagraph) currentParagraph.classList.remove('active'); currentParagraph = null; activeParaElement = null; document.getElementById('currentReviews').innerHTML = '<div class="no-reviews">请点击左侧段落查看对应本章说</div>'; }
    function searchText(query) { if (currentParagraph) currentParagraph.classList.remove('active'); query = query ? query.toLowerCase() : ""; const chapterHasVisibleParagraph = {}; document.querySelectorAll('.paragraph').forEach(para => { const chapterIndex = para.dataset.chapterIndex; const paraIndex = para.dataset.paraIndex; if (!allChapters[chapterIndex] || allChapters[chapterIndex].paragraphs[paraIndex] === undefined) { para.style.display = 'none'; return; } const paragraph = allChapters[chapterIndex].paragraphs[paraIndex]; let showPara = !query; let highlightedText = paragraph.replace(/</g, "&lt;").replace(/>/g, "&gt;"); if (query) { if (paragraph.toLowerCase().includes(query)) { showPara = true; highlightedText = paragraph.replace(new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), match => `<span class="highlight">${match}</span>`); } if (!showPara && allReviews[chapterIndex] && allReviews[chapterIndex][paraIndex]) { if (allReviews[chapterIndex][paraIndex].some(r => r.user.toLowerCase().includes(query) || r.text.toLowerCase().includes(query))) showPara = true; } } para.style.display = showPara ? 'block' : 'none'; if (showPara) { chapterHasVisibleParagraph[chapterIndex] = true; const reviewCount = allReviews[chapterIndex]?.[paraIndex]?.length || 0; const reviewCountSpan = reviewCount > 0 ? `<span class="review-count">${reviewCount}条</span>` : ''; para.innerHTML = `<b>段 ${parseInt(paraIndex) + 1}：</b> ${highlightedText} ${reviewCountSpan}`; } }); document.querySelectorAll('.chapter-title').forEach(title => { title.style.display = (currentChapterIndex === 'all' && !query) || chapterHasVisibleParagraph[title.dataset.chapterIndex] ? 'block' : 'none'; }); if (activeParaElement && document.getElementById(activeParaElement.id)?.style.display !== 'none') { currentParagraph = document.getElementById(activeParaElement.id); currentParagraph.classList.add('active'); } else { currentParagraph = null; } }
    function toggleMobileView() { const novelSection = document.getElementById('novelContent'); const reviewsSection = document.getElementById('reviewsContent'); const toggleButton = document.getElementById('mobileViewToggle'); if (currentView === 'novel') { novelSection.style.display = 'none'; reviewsSection.style.display = 'block'; toggleButton.textContent = '查看小说'; currentView = 'reviews'; document.getElementById('reviewsContent').scrollTop = 0; } else { novelSection.style.display = 'block'; reviewsSection.style.display = 'none'; toggleButton.textContent = '查看本章说'; currentView = 'novel'; window.scrollTo({ top: scrollPosBeforeReview, behavior: 'auto' }); } }
    function toggleChapterMenu() { document.getElementById('chapterMenu').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    function goToPreviousChapter() { if (currentChapterIndex === 'all' || allChapters.length === 0 || allChapters.length <= 1) return; let currentIndex = parseInt(currentChapterIndex); if (currentIndex > 0) { currentChapterIndex = currentIndex - 1; clearActiveParagraphAndReviews(); renderContent(); document.getElementById('chapterSelector').value = currentChapterIndex; updateChapterNavButtons(); window.scrollTo(0,0); } }
    function goToNextChapter() { if (currentChapterIndex === 'all' || allChapters.length === 0 || allChapters.length <= 1) return; let currentIndex = parseInt(currentChapterIndex); if (currentIndex < allChapters.length - 1) { currentChapterIndex = currentIndex + 1; clearActiveParagraphAndReviews(); renderContent(); document.getElementById('chapterSelector').value = currentChapterIndex; updateChapterNavButtons(); window.scrollTo(0,0); } }
    function updateChapterNavButtons() { const prevBtn = document.getElementById('prevChapterBtn'); const nextBtn = document.getElementById('nextChapterBtn'); if (currentChapterIndex === 'all' || allChapters.length <= 1) { prevBtn.disabled = true; nextBtn.disabled = true; } else { const idx = parseInt(currentChapterIndex); prevBtn.disabled = idx === 0; nextBtn.disabled = idx === allChapters.length - 1; } }
    function handleResize() { const novelSection = document.getElementById('novelContent'); const reviewsSection = document.getElementById('reviewsContent'); const toggleButton = document.getElementById('mobileViewToggle'); const chapterSelector = document.getElementById('chapterSelector'); if (window.innerWidth > 768) { novelSection.style.display = 'block'; reviewsSection.style.display = 'block'; toggleButton.style.display = 'none'; chapterSelector.style.display = 'block'; currentView = 'both'; } else { toggleButton.style.display = 'block'; chapterSelector.style.display = 'none'; if (currentView === 'reviews') { novelSection.style.display = 'none'; reviewsSection.style.display = 'block'; toggleButton.textContent = '查看小说'; } else { currentView = 'novel'; novelSection.style.display = 'block'; reviewsSection.style.display = 'none'; toggleButton.textContent = '查看本章说'; } } updateProgressBar(); }
</script>

</body>
</html>